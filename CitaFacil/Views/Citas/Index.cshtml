@model IEnumerable<CitaFacil.Models.Cita>
@using System.Globalization
@using System.Linq
@using CitaFacil.Constants

@{
    var esAdmin = User.IsInRole(Roles.Administrador);
    var esDoctor = User.IsInRole(Roles.Doctor);
    Layout = esAdmin ? "_AdminLayout" : esDoctor ? "_DoctorLayout" : "_PatientLayout";
    ViewData["Title"] = esAdmin ? "Gestión de citas" : esDoctor ? "Citas programadas" : "Resumen de mis citas";

    static string ConstruirNombreCompleto(string? nombre, string? apellido, string? segundoApellido)
    {
        var partes = new[] { nombre, apellido, segundoApellido }
            .Where(s => !string.IsNullOrWhiteSpace(s))
            .Select(s => s!.Trim());

        var resultado = string.Join(" ", partes);
        return string.IsNullOrWhiteSpace(resultado) ? "--" : resultado;
    }

    static string ObtenerClasesEstado(string? estado)
    {
        var codigo = (estado ?? string.Empty).Trim().ToUpperInvariant();
        return codigo switch
        {
            "CONFIRMADA" => "bg-green-100 text-green-800 dark:bg-green-900/60 dark:text-green-300",
            "COMPLETADA" => "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/60 dark:text-emerald-300",
            "CANCELADA" => "bg-red-100 text-red-800 dark:bg-red-900/60 dark:text-red-300",
            "REPROGRAMADA" => "bg-amber-100 text-amber-800 dark:bg-amber-900/60 dark:text-amber-300",
            _ => "bg-sky-100 text-sky-800 dark:bg-sky-900/60 dark:text-sky-200"
        };
    }

    static string ObtenerEtiquetaEstado(string? estado)
    {
        if (string.IsNullOrWhiteSpace(estado))
        {
            return "Pendiente";
        }

        var cultura = CultureInfo.GetCultureInfo("es-MX");
        var texto = estado.Trim().ToLower(cultura);
        return cultura.TextInfo.ToTitleCase(texto);
    }

    static string FormatearFecha(DateTime fecha)
    {
        var cultura = CultureInfo.GetCultureInfo("es-MX");
        return fecha.ToString("dd 'de' MMMM yyyy", cultura);
    }
}

<div class="space-y-8">
    <div class="flex flex-wrap items-start justify-between gap-4">
        <div class="space-y-1">
            <h1 class="text-3xl font-bold tracking-[-0.03em] text-slate-900 dark:text-slate-100">@ViewData["Title"]</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">
                Consulta el listado actualizado de citas @if (esAdmin) {<text>registradas en la plataforma.</text>} else if (esDoctor) {<text>asignadas a tu agenda.</text>} else {<text>programadas para ti.</text>}
            </p>
        </div>

        @if (esAdmin)
        {
            <div class="flex items-center gap-3">
                <a asp-action="Create"
                   class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-dark">
                    <span class="material-symbols-outlined text-base">event_available</span>
                    <span>Nueva cita</span>
                </a>
            </div>
        }
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-800">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">Fecha</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">Hora</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">Paciente</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">Doctor</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">Motivo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">Estado</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 bg-white text-sm dark:divide-slate-800 dark:bg-slate-900/50">
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-slate-500 dark:text-slate-400">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-700">calendar_month</span>
                                    <p class="font-medium">No hay citas registradas</p>
                                    <p class="text-sm">Cuando se agenden citas aparecerán en este listado.</p>
                                </div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var cita in Model)
                        {
                            var paciente = ConstruirNombreCompleto(cita.Paciente?.nombre, cita.Paciente?.apellido, cita.Paciente?.segundo_apellido);
                            var doctor = ConstruirNombreCompleto(cita.Doctor?.nombre, cita.Doctor?.apellido, cita.Doctor?.segundo_apellido);
                            var motivo = string.IsNullOrWhiteSpace(cita.motivo) ? "--" : cita.motivo;
                            var estadoClases = ObtenerClasesEstado(cita.estado);
                            var estadoEtiqueta = ObtenerEtiquetaEstado(cita.estado);
                            var horaFormateada = cita.hora.ToString(@"hh\:mm");
                            var fechaFormateada = FormatearFecha(cita.fecha);

                            <tr class="hover:bg-slate-50/80 dark:hover:bg-slate-800/50 transition-colors">
                                <td class="whitespace-nowrap px-6 py-4 font-medium text-slate-900 dark:text-slate-100">@fechaFormateada</td>
                                <td class="whitespace-nowrap px-6 py-4 text-slate-600 dark:text-slate-300">@horaFormateada h</td>
                                <td class="px-6 py-4 text-slate-600 dark:text-slate-300">
                                    <div class="flex items-center gap-3">
                                        <div class="flex h-9 w-9 items-center justify-center rounded-full bg-primary/10 text-primary">
                                            <span class="material-symbols-outlined text-base">person</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="font-medium text-slate-900 dark:text-slate-100">@paciente</span>
                                            <span class="text-xs text-slate-500 dark:text-slate-400">ID paciente: @cita.paciente_id</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-slate-600 dark:text-slate-300">
                                    <div class="flex items-center gap-3">
                                        <div class="flex h-9 w-9 items-center justify-center rounded-full bg-sky-100 text-sky-700 dark:bg-sky-900/40 dark:text-sky-200">
                                            <span class="material-symbols-outlined text-base">stethoscope</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="font-medium text-slate-900 dark:text-slate-100">@doctor</span>
                                            <span class="text-xs text-slate-500 dark:text-slate-400">ID doctor: @cita.doctor_id</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-slate-600 dark:text-slate-300">@motivo</td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold @estadoClases">
                                        <span class="material-symbols-outlined text-sm">radio_button_unchecked</span>
                                        @estadoEtiqueta
                                    </span>
                                </td>
                                <td class="whitespace-nowrap px-6 py-4">
                                    <div class="flex items-center justify-end gap-2">
                                        <a asp-action="Details" asp-route-id="@cita.id"
                                           class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-primary hover:text-primary dark:border-slate-700 dark:text-slate-300 dark:hover:border-primary dark:hover:text-primary">
                                            <span class="material-symbols-outlined text-sm">visibility</span>
                                            <span>Detalles</span>
                                        </a>

                                        @if (esAdmin)
                                        {
                                            <a asp-action="Edit" asp-route-id="@cita.id"
                                               class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-primary hover:text-primary dark:border-slate-700 dark:text-slate-300 dark:hover:border-primary dark:hover:text-primary">
                                                <span class="material-symbols-outlined text-sm">edit</span>
                                                <span>Editar</span>
                                            </a>
                                            <a asp-action="Delete" asp-route-id="@cita.id"
                                               class="inline-flex items-center gap-1 rounded-lg border border-red-200 px-3 py-1.5 text-xs font-semibold text-red-600 transition hover:bg-red-50 dark:border-red-700 dark:text-red-400 dark:hover:bg-red-900/40">
                                                <span class="material-symbols-outlined text-sm">delete</span>
                                                <span>Eliminar</span>
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
