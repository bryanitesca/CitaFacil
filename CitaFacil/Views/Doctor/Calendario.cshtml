@{
    Layout = "_DoctorLayout";
    ViewData["Title"] = "Calendario de Citas";
}

<!-- Main Content -->
<main class="flex flex-1 flex-col overflow-y-auto">
    <div class="flex flex-col p-6 md:p-8">
        <form id="doctor-calendar-antiforgery" class="hidden" method="post">@Html.AntiForgeryToken()</form>
        <!-- PageHeading -->
        <header class="flex flex-wrap items-center justify-between gap-4 border-b border-gray-200 pb-6 dark:border-gray-800">
            <div class="flex min-w-72 flex-col gap-2">
                <p class="text-[#111318] dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Calendario</p>
                <p class="text-[#616f89] dark:text-gray-400 text-base font-normal leading-normal">Gestiona tus citas de forma rápida y sencilla.</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- SegmentedButtons -->
                <div class="flex h-10 w-64 items-center justify-center rounded-lg bg-gray-200/50 p-1 dark:bg-white/10">
                    <label class="flex h-full flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-[0.375rem] px-2 text-sm font-medium leading-normal text-[#616f89] has-[:checked]:bg-white has-[:checked]:text-[#111318] has-[:checked]:shadow-sm dark:text-gray-400 dark:has-[:checked]:bg-background-dark dark:has-[:checked]:text-white">
                        <span class="truncate">Día</span>
                        <input class="invisible w-0" name="calendarView" type="radio" value="timeGridDay"/>
                    </label>
                    <label class="flex h-full flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-[0.375rem] px-2 text-sm font-medium leading-normal text-[#616f89] has-[:checked]:bg-white has-[:checked]:text-[#111318] has-[:checked]:shadow-sm dark:text-gray-400 dark:has-[:checked]:bg-background-dark dark:has-[:checked]:text-white">
                        <span class="truncate">Semana</span>
                        <input checked="" class="invisible w-0" name="calendarView" type="radio" value="timeGridWeek"/>
                    </label>
                    <label class="flex h-full flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-[0.375rem] px-2 text-sm font-medium leading-normal text-[#616f89] has-[:checked]:bg-white has-[:checked]:text-[#111318] has-[:checked]:shadow-sm dark:text-gray-400 dark:has-[:checked]:bg-background-dark dark:has-[:checked]:text-white">
                        <span class="truncate">Mes</span>
                        <input class="invisible w-0" name="calendarView" type="radio" value="dayGridMonth"/>
                    </label>
                </div>
            </div>
        </header>

        <!-- Toolbar & Calendar Grid -->
        <div class="mt-6 flex flex-1 flex-col">
            <!-- ToolBar -->
            <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-2">
                    <button id="calendar-prev" class="flex h-10 w-10 items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-white/10">
                        <span class="material-symbols-outlined text-[#111318] dark:text-white">chevron_left</span>
                    </button>
                    <button id="calendar-next" class="flex h-10 w-10 items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-white/10">
                        <span class="material-symbols-outlined text-[#111318] dark:text-white">chevron_right</span>
                    </button>
                    <p id="calendar-title" class="text-xl font-bold text-[#111318] dark:text-white">Calendario</p>
                </div>
                <button id="calendar-today" class="flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg border border-gray-300 bg-white px-4 text-sm font-bold leading-normal tracking-[0.015em] text-[#111318] dark:border-gray-700 dark:bg-background-dark dark:text-white">
                    <span class="truncate">Hoy</span>
                </button>
            </div>

            <!-- Calendar Container -->
            <div class="mt-4">
                <div id="calendar" class="bg-white dark:bg-background-dark rounded-lg border border-gray-200 dark:border-gray-800"></div>
            </div>
        </div>
    </div>
</main>

<!-- Modales -->
@await Html.PartialAsync("_ModalDetallesCita")

@section Scripts {
    <script src="~/js/fullcalendar.index.global.min.js" asp-append-version="true"></script>
    <script src="~/js/fullcalendar.es.global.min.js" asp-append-version="true"></script>
    <script src="~/js/calendar-modals.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: 'timeGridWeek',
                headerToolbar: false,
                height: 'auto',
                contentHeight: 700,
                slotMinTime: '07:00:00',
                slotMaxTime: '20:00:00',
                slotDuration: '00:30:00',
                slotLabelInterval: '01:00:00',
                allDaySlot: false,
                expandRows: true,
                nowIndicator: true,
                eventMinHeight: 50,
                slotEventOverlap: false,
                businessHours: {
                    daysOfWeek: [1, 2, 3, 4, 5, 6],
                    startTime: '08:00',
                    endTime: '18:00'
                },
                events: '@Url.Action("GetCitasJson", "Doctor")',
                eventClick: function(info) {
                    showAppointmentDetails(info.event.id);
                },
                eventContent: function(arg) {
                    var estado = arg.event.extendedProps.estado;
                    var paciente = arg.event.extendedProps.pacienteNombre || 'Sin nombre';
                    var motivo = arg.event.extendedProps.motivo || 'Consulta general';
                    var esVirtual = arg.event.extendedProps.esVirtual;
                    
                    // Crear contenido HTML personalizado
                    var html = '<div class="fc-event-custom" style="padding: 6px; height: 100%;">';
                    html += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 2px;">' + paciente + '</div>';
                    html += '<div style="font-size: 11px; opacity: 0.9;">' + motivo.substring(0, 30) + (motivo.length > 30 ? '...' : '') + '</div>';
                    
                    if (esVirtual) {
                        html += '<div style="display: flex; align-items: center; gap: 2px; margin-top: 4px; font-size: 10px;">';
                        html += '<span class="material-symbols-outlined" style="font-size: 12px;">videocam</span>';
                        html += 'Virtual';
                        html += '</div>';
                    }
                    
                    html += '<div style="font-size: 10px; margin-top: 4px; padding: 2px 6px; background: rgba(255,255,255,0.2); border-radius: 4px; display: inline-block;">' + estado + '</div>';
                    html += '</div>';
                    
                    return { html: html };
                },
                eventDidMount: function(info) {
                    var estado = info.event.extendedProps.estado;
                    var color = '#6b7280';
                    
                    if (estado === 'PENDIENTE') {
                        color = '#f59e0b';
                    } else if (estado === 'CONFIRMADA') {
                        color = '#10b981';
                    } else if (estado === 'COMPLETADA') {
                        color = '#3b82f6';
                    } else if (estado === 'CANCELADA') {
                        color = '#ef4444';
                    }
                    
                    info.el.style.backgroundColor = color;
                    info.el.style.borderColor = color;
                    info.el.style.borderWidth = '2px';
                    info.el.style.borderRadius = '8px';
                    info.el.style.color = 'white';
                    info.el.style.cursor = 'pointer';
                    info.el.style.transition = 'transform 0.2s, box-shadow 0.2s';
                    
                    info.el.addEventListener('mouseenter', function() {
                        this.style.transform = 'scale(1.02)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    });
                    
                    info.el.addEventListener('mouseleave', function() {
                        this.style.transform = 'scale(1)';
                        this.style.boxShadow = 'none';
                    });
                }
            });

            calendar.render();

            function updateCalendarTitle() {
                var title = calendar.view.title;
                document.getElementById('calendar-title').textContent = title;
            }
            updateCalendarTitle();

            document.getElementById('calendar-prev').addEventListener('click', function() {
                calendar.prev();
                updateCalendarTitle();
            });

            document.getElementById('calendar-next').addEventListener('click', function() {
                calendar.next();
                updateCalendarTitle();
            });

            document.getElementById('calendar-today').addEventListener('click', function() {
                calendar.today();
                updateCalendarTitle();
            });

            document.querySelectorAll('input[name="calendarView"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        calendar.changeView(this.value);
                        updateCalendarTitle();
                    }
                });
            });

            window.doctorCalendar = calendar;
        });
    </script>
    <style>
        .fc-timegrid-slot {
            height: 3em !important;
        }
        
        .fc-timegrid-event {
            border-radius: 8px !important;
            overflow: hidden;
        }
        
        .fc-event-custom {
            line-height: 1.3;
        }
        
        .fc-timegrid-now-indicator-line {
            border-color: #ef4444 !important;
            border-width: 2px !important;
        }
        
        .fc-timegrid-now-indicator-arrow {
            border-color: #ef4444 !important;
        }
        
        .fc .fc-business-hours {
            background-color: rgba(59, 130, 246, 0.03) !important;
        }
    </style>
}