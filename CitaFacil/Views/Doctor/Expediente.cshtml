@model CitaFacil.ViewModels.DoctorPatientDetailViewModel
@using System.Globalization

@{
    Layout = "_DoctorLayout";
    ViewData["Title"] = "Expediente del paciente";

    var cultura = CultureInfo.GetCultureInfo("es-MX");

    string FormatearFechaHora(DateTime fecha, TimeSpan? hora)
        => (fecha + (hora ?? TimeSpan.Zero)).ToString("dd MMM yyyy - HH:mm", cultura);

}

<div class="space-y-10">
    <div class="flex flex-wrap items-start justify-between gap-6">
        <div class="flex items-center gap-4">
            <div class="flex h-16 w-16 items-center justify-center rounded-full bg-primary/15 text-xl font-semibold uppercase text-primary">
                @Model.AvatarIniciales
            </div>
            <div class="space-y-1">
                <h1 class="text-3xl font-bold tracking-[-0.03em] text-slate-900 dark:text-white">@Model.NombreCompleto</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">ID paciente: @Model.PacienteId</p>
            </div>
        </div>
        <div class="flex flex-wrap gap-3">
            <a asp-action="Pacientes" class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-dark">
                <span class="material-symbols-outlined text-sm">arrow_back</span>
                Volver a la lista
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-4 lg:grid-cols-4">
        <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60 lg:col-span-2">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Datos del paciente</h2>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                <div>
                    <p class="text-xs uppercase text-slate-400">Correo electrónico</p>
                    <p class="text-sm font-medium text-slate-700 dark:text-slate-200">@(string.IsNullOrWhiteSpace(Model.Correo) ? "Sin correo registrado" : Model.Correo)</p>
                </div>
                <div>
                <p class="text-xs uppercase text-slate-400">Celular</p>
                <p class="text-sm font-medium text-slate-700 dark:text-slate-200">@(string.IsNullOrWhiteSpace(Model.Telefono) ? "Sin celular" : Model.Telefono)</p>
                </div>
                <div>
                    <p class="text-xs uppercase text-slate-400">Fecha de nacimiento</p>
                    <p class="text-sm font-medium text-slate-700 dark:text-slate-200">@(Model.FechaNacimiento?.ToString("dd MMM yyyy", cultura) ?? "Sin registro")</p>
                </div>
                <div>
                    <p class="text-xs uppercase text-slate-400">Género</p>
                    <p class="text-sm font-medium text-slate-700 dark:text-slate-200">@(string.IsNullOrWhiteSpace(Model.Genero) ? "No especificado" : Model.Genero)</p>
                </div>
                <div class="md:col-span-2">
                    <p class="text-xs uppercase text-slate-400">Dirección</p>
                    <p class="text-sm font-medium text-slate-700 dark:text-slate-200">@(string.IsNullOrWhiteSpace(Model.Direccion) ? "No capturada" : Model.Direccion)</p>
                </div>
            </div>
        </div>
        <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Resumen de citas</h2>
            <dl class="space-y-3 text-sm text-slate-600 dark:text-slate-300">
                <div class="flex items-center justify-between"><dt>Total registradas</dt><dd class="font-semibold text-slate-900 dark:text-slate-100">@Model.TotalCitas</dd></div>
                <div class="flex items-center justify-between"><dt>Confirmadas</dt><dd class="font-semibold text-emerald-600 dark:text-emerald-300">@Model.CitasConfirmadas</dd></div>
                <div class="flex items-center justify-between"><dt>Pendientes</dt><dd class="font-semibold text-amber-600 dark:text-amber-300">@Model.CitasPendientes</dd></div>
                <div class="flex items-center justify-between"><dt>Completadas</dt><dd class="font-semibold text-slate-700 dark:text-slate-200">@Model.CitasCompletadas</dd></div>
                <div class="flex items-center justify-between"><dt>Canceladas</dt><dd class="font-semibold text-rose-500 dark:text-rose-300">@Model.CitasCanceladas</dd></div>
            </dl>
        </div>
        <div class="space-y-3 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Accesos rápidos</h2>
            <div class="space-y-2 text-sm">
                <a asp-action="Contacto" asp-route-id="@Model.PacienteId" class="flex items-center gap-2 rounded-lg bg-primary/10 px-3 py-2 text-primary hover:bg-primary/20 dark:bg-primary/15 dark:hover:bg-primary/25">
                    <span class="material-symbols-outlined text-base">send</span>
                    Enviar aviso
                </a>
            </div>
        </div>
    </div>

    <section class="space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Historial de citas</h2>
            <span class="text-xs font-medium uppercase tracking-wide text-slate-400">@Model.TotalCitas en total</span>
        </div>

        @if (!Model.Historial.Any())
        {
            <div class="rounded-2xl border border-slate-200 bg-white p-6 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-300">
                No hay citas registradas con este paciente.
            </div>
        }
        else
        {
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
                <div class="flow-root">
                    <ul class="-mb-4">
                        @foreach (var cita in Model.Historial)
                        {
                            var estado = (cita.estado ?? string.Empty).Trim().ToUpperInvariant();
                            var estadoClase = estado switch
                            {
                                "CONFIRMADA" => "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300",
                                "PENDIENTE" => "bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300",
                                "REPROGRAMADA" => "bg-sky-100 text-sky-700 dark:bg-sky-900/40 dark:text-sky-300",
                                "CANCELADA" => "bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300",
                                "COMPLETADA" => "bg-slate-200 text-slate-700 dark:bg-slate-800/60 dark:text-slate-300",
                                _ => "bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-300"
                            };
                            <li class="relative pb-6">
                                <span class="absolute left-4 top-2 h-full border-l border-dashed border-slate-200 dark:border-slate-700"></span>
                                <div class="relative ml-10 rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/80">
                                    <div class="flex flex-wrap items-start justify-between gap-4">
                                        <div>
                                            <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">@FormatearFechaHora(cita.fecha, cita.hora)</p>
                                            <p class="text-xs text-slate-500 dark:text-slate-400">Motivo: @(string.IsNullOrWhiteSpace(cita.motivo) ? "No especificado" : cita.motivo)</p>
                                        </div>
                                        <span class=$"inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold {estadoClase}">
                                            <span class="material-symbols-outlined text-sm">radio_button_unchecked</span>
                                            @(string.IsNullOrWhiteSpace(cita.estado) ? "Sin estado" : cita.estado)
                                        </span>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(cita.notas))
                                    {
                                        <div class="mt-3 rounded-lg bg-slate-50 px-3 py-2 text-xs text-slate-500 dark:bg-slate-800/60 dark:text-slate-300">
                                            <span class="font-medium text-slate-600 dark:text-slate-200">Notas:</span> @cita.notas
                                        </div>
                                    }
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }
    </section>
</div>

