@model CitaFacil.ViewModels.Admin.DatabaseBackupPageViewModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Respaldos de base de datos";

    string FormatearUtc(DateTime? utc) =>
        utc.HasValue ? utc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm") : "Sin registros";
}

<div class="space-y-8">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="space-y-1">
            <h1 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Respaldos de base de datos</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Configura respaldos automáticos, genera respaldos manuales y restaura la base de datos desde un archivo .bak.</p>
        </div>
        <a asp-action="Index" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-primary hover:text-primary dark:border-slate-700 dark:text-slate-300 dark:hover:border-primary dark:hover:text-primary">
            <span class="material-symbols-outlined text-base">arrow_back</span>
            Volver al panel
        </a>
    </div>

    @if (TempData["SuccessMessage"] is string successMessage)
    {
        <div class="rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200">
            <span class="font-semibold">&Eacute;xito:</span> @successMessage
        </div>
    }

    @if (TempData["ErrorMessage"] is string errorMessage)
    {
        <div class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/30 dark:text-red-200">
            <span class="font-semibold">Error:</span> @errorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model?.LastError))
    {
        <div class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/30 dark:text-red-200">
            <span class="font-semibold">Atencion:</span> @Model.LastError
        </div>
    }

    <div class="grid gap-6 lg:grid-cols-[1.4fr_1fr]">
        <section class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
            <header class="space-y-1">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Configuracion</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Define la carpeta de destino, el horario automatico y la politica de retencion.</p>
            </header>

            <form asp-action="ActualizarBackupConfig" method="post" class="space-y-5" id="backup-config-form">
                @Html.AntiForgeryToken()
                @if (!ViewData.ModelState.IsValid)
                {
                    <div asp-validation-summary="ModelOnly" class="mb-3 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-600"></div>
                }

                <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Carpeta de respaldos</label>
                    <div class="flex flex-col gap-2 sm:flex-row">
                        <input asp-for="Config.BackupDirectory"
                               readonly
                               id="backup-directory-input"
                               class="form-input h-11 flex-1 rounded-xl border-slate-200 bg-white px-4 text-sm text-slate-700 shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200" />
                        <button type="button" id="select-directory-btn" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-primary hover:text-primary dark:border-slate-700 dark:text-slate-300 dark:hover:border-primary dark:hover:text-primary">
                            <span class="material-symbols-outlined text-base">folder_open</span>
                            Seleccionar
                        </button>
                    </div>
                    <span asp-validation-for="Config.BackupDirectory" class="text-xs text-red-500"></span>
                    <p class="text-xs text-slate-500 dark:text-slate-400">La ruta se valida automaticamente al elegir la carpeta.</p>
                    <p id="directory-feedback" class="hidden rounded-lg border px-3 py-2 text-xs"></p>
                </div>

                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                    <label class="flex flex-col gap-2">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Hora del respaldo automatico</span>
                        <input asp-for="Config.AutoBackupTime"
                               type="time"
                               class="form-input h-11 rounded-xl border-slate-200 bg-white px-4 text-sm text-slate-700 shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200" />
                        <span asp-validation-for="Config.AutoBackupTime" class="text-xs text-red-500"></span>
                    </label>
                    <label class="flex flex-col gap-2">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Retencion (dias)</span>
                        <input asp-for="Config.RetentionDays"
                               type="number"
                               min="0"
                               max="30"
                               step="1"
                               class="form-input h-11 rounded-xl border-slate-200 bg-white px-4 text-sm text-slate-700 shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200" />
                        <span asp-validation-for="Config.RetentionDays" class="text-xs text-red-500"></span>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Los respaldos mas antiguos se eliminaran automaticamente.</p>
                    </label>
                </div>

                <label class="flex items-center gap-3 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
                    <input asp-for="Config.AutoBackupEnabled" class="size-4 rounded border-slate-300 text-primary focus:ring-primary/40" />
                    <span>Habilitar respaldo automatico diario.</span>
                </label>

                <div class="grid grid-cols-1 gap-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300 md:grid-cols-2">
                    <div>
                        <p class="text-xs uppercase text-slate-500">Ultimo respaldo</p>
                        <p class="mt-1 font-semibold text-slate-800 dark:text-slate-100">@FormatearUtc(Model.Config.LastBackupUtc)</p>
                    </div>
                    <div>
                        <p class="text-xs uppercase text-slate-500">Ultimo respaldo automatico</p>
                        <p class="mt-1 font-semibold text-slate-800 dark:text-slate-100">@FormatearUtc(Model.Config.LastAutomaticBackupUtc)</p>
                    </div>
                </div>

                <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary/40">
                    <span class="material-symbols-outlined text-base">save</span>
                    Guardar configuración
                </button>
            </form>
        </section>

        <aside class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
            <div class="space-y-3">
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Respaldo manual</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Genera un respaldo completo inmediatamente en la carpeta configurada.</p>
                <form asp-action="EjecutarRespaldoManual" method="post" class="space-y-3">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-400">
                        <span class="material-symbols-outlined text-base">cloud_upload</span>
                        Generar respaldo ahora
                    </button>
                </form>
            </div>

            <div class="space-y-3 border-t border-slate-200 pt-6 dark:border-slate-700">
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Restaurar desde archivo</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Selecciona un archivo .bak para restaurar la base de datos. Este proceso sobrescribira la informacion actual.</p>
                <form asp-action="RestaurarBackup" method="post" enctype="multipart/form-data" class="space-y-3">
                    @Html.AntiForgeryToken()
                    <input type="file" name="archivoRespaldo" accept=".bak" class="block w-full cursor-pointer rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200" />
                    <p class="text-xs text-amber-600 dark:text-amber-400">Durante la restauracion la base de datos entrara en modo de usuario unico temporalmente.</p>
                    <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-amber-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        <span class="material-symbols-outlined text-base">history</span>
                        Restaurar desde .bak
                    </button>
                </form>
            </div>
        </aside>
    </div>

    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
        <header class="flex flex-wrap items-center justify-between gap-4 pb-4">
            <div>
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Historial reciente</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Muestra los ultimos respaldos y restauraciones realizados.</p>
            </div>
        </header>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 text-sm">
                <thead class="bg-slate-50 dark:bg-slate-900/50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">
                    <tr>
                        <th class="px-4 py-3">Fecha</th>
                        <th class="px-4 py-3">Tipo</th>
                        <th class="px-4 py-3">Estado</th>
                        <th class="px-4 py-3">Archivo</th>
                        <th class="px-4 py-3">Mensaje</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                    @if (Model.History.Count == 0)
                    {
                        <tr>
                            <td colspan="5" class="px-4 py-6 text-center text-slate-500 dark:text-slate-400">Aun no se registran respaldos.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in Model.History)
                        {
                            var statusClasses = item.status == "SUCCESS"
                                ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300"
                                : "bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300";

                            <tr class="text-slate-700 dark:text-slate-200">
                                <td class="px-4 py-3">@item.created_utc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-300">
                                        @item.operation_type
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold uppercase @statusClasses">
                                        @item.status
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex flex-col">
                                        <span class="font-medium">@item.file_name</span>
                                        <span class="text-xs text-slate-500 dark:text-slate-400">@item.file_path</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-400">@item.message</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </section>
</div>

<div id="directory-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto mt-20 w-full max-w-3xl rounded-2xl bg-white p-6 shadow-xl dark:bg-slate-900">
        <div class="flex items-center justify-between border-b border-slate-200 pb-4 dark:border-slate-700">
            <div>
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Seleccionar carpeta</h3>
                <p id="directory-modal-path" class="mt-1 text-xs text-slate-500 dark:text-slate-400"></p>
            </div>
            <button type="button" id="directory-modal-close" class="rounded-full p-2 text-slate-500 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined text-base">close</span>
            </button>
        </div>
        <div class="mt-4 flex flex-col gap-3">
            <div class="flex items-center gap-2">
                <button type="button" id="directory-modal-up" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:border-primary hover:text-primary dark:border-slate-700 dark:text-slate-300 dark:hover:border-primary dark:hover:text-primary">
                    <span class="material-symbols-outlined text-sm">arrow_upward</span>
                    Subir un nivel
                </button>
                <p id="directory-modal-error" class="text-xs text-red-500"></p>
            </div>
            <div class="max-h-72 overflow-y-auto rounded-xl border border-slate-200 dark:border-slate-700">
                <ul id="directory-list" class="divide-y divide-slate-200 dark:divide-slate-700"></ul>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button type="button" id="directory-modal-cancel" class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-primary hover:text-primary dark:border-slate-700 dark:text-slate-300 dark:hover:border-primary dark:hover:text-primary">Cancelar</button>
            <button type="button" id="directory-modal-accept" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary/40" disabled>
                <span class="material-symbols-outlined text-base">check_circle</span>
                Usar esta carpeta
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js" asp-append-version="true"></script>
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script src="~/js/backup-config.js" asp-append-version="true"></script>
    <script>
        window.backupConfigOptions = {
            listUrl: '@Url.Action("ListarDirectorios")',
            validateUrl: '@Url.Action("ValidarCarpeta")'
        };
    </script>
}

